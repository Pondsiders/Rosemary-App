#!/bin/bash
# Launch Rosemary (Python backend + React frontend)

set -e
cd /Pondside/Workshop/Projects/Rosemary/Rosemary-App

BACKEND_PORT=8779
FRONTEND_PORT=8780

# Guard: make sure op run was used to resolve secrets.
# Without it, the shell's own DATABASE_URL (Alpha's Postgres) leaks through
# and Rosemary connects to the wrong database.
if [[ -z "$ROSEMARY_SECRETS" ]]; then
    echo "âŒ Rosemary secrets not loaded."
    echo "   Run with: op run --env-file=.env.op -- ./rosemary-app"
    exit 1
fi

# Figure out what URL to advertise
CERT_DIR="/Pondside/Basement/Files/certs"
TAILSCALE_HOST=$(tailscale status --json 2>/dev/null | python3 -c "import json,sys; print(json.load(sys.stdin)['Self']['DNSName'].rstrip('.'))" 2>/dev/null)

if [[ -n "$TAILSCALE_HOST" && -f "$CERT_DIR/$TAILSCALE_HOST.crt" ]]; then
    FRONTEND_URL="https://${TAILSCALE_HOST}:${FRONTEND_PORT}"
else
    FRONTEND_URL="http://localhost:${FRONTEND_PORT}"
fi

echo "ðŸŒ¿ Starting Rosemary..."
echo "   Backend:  http://localhost:${BACKEND_PORT} (Python)"
echo "   Frontend: $FRONTEND_URL"
echo ""

npx concurrently \
    --names "backend,frontend" \
    --prefix-colors "green,cyan" \
    --kill-others \
    "cd backend-py && uv run uvicorn rosemary_app.main:app --host 0.0.0.0 --port ${BACKEND_PORT}" \
    "cd frontend && VITE_PORT=${FRONTEND_PORT} VITE_BACKEND_PORT=${BACKEND_PORT} npm run dev"
