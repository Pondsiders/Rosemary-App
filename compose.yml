services:
  rosemary:
    build:
      context: ..
      dockerfile: Rosemary-App/Dockerfile
    command:
      - python
      - -m
      - uvicorn
      - rosemary_app.main:app
      - --host=0.0.0.0
      - --port=8780
      - --ssl-certfile=/certs/primer.tail8bd569.ts.net.crt
      - --ssl-keyfile=/certs/primer.tail8bd569.ts.net.key
    environment:
      - TZ=America/Los_Angeles
      - OLLAMA_URL=http://primer:8200
      - OLLAMA_MODEL=gemma3:12b-it-qat
      - ROSEMARY_CWD=/home/rosemary
      - ROSEMARY_PLUGIN_DIR=/home/rosemary/plugin
    env_file: .env
    dns:
      - 100.100.100.100  # Tailscale
      - 1.1.1.1          # Cloudflare
    volumes:
      # Rosemary's persistent home — backed up by Restic via Pondside
      - /Pondside/Workshop/Projects/Rosemary/home:/home/rosemary
      # Plugin (read-write — her soul, skills, prompts)
      - /Pondside/Workshop/Projects/Rosemary/Rosemary-Plugin:/home/rosemary/plugin
      # Claude credentials (read-write so the SDK can persist token refreshes)
      - /home/jefferyharrell/.claude/.credentials.json:/home/rosemary/.claude/.credentials.json
      # Tailscale certs
      - /Pondside/Basement/Files/certs:/certs:ro
    ports:
      - "8780:8780"
    restart: unless-stopped

  rosemary-nights:
    build:
      context: ..
      dockerfile: Rosemary-App/Dockerfile
    command: ["python", "-m", "rosemary_app.nights"]
    environment:
      - TZ=America/Los_Angeles
      - OLLAMA_URL=http://primer:8200
      - OLLAMA_MODEL=gemma3:12b-it-qat
      - ROSEMARY_CWD=/home/rosemary
      - ROSEMARY_PLUGIN_DIR=/home/rosemary/plugin
    env_file: .env
    dns:
      - 100.100.100.100
      - 1.1.1.1
    volumes:
      # Rosemary's persistent home
      - /Pondside/Workshop/Projects/Rosemary/home:/home/rosemary
      # Plugin (read-write)
      - /Pondside/Workshop/Projects/Rosemary/Rosemary-Plugin:/home/rosemary/plugin
      # Claude credentials (read-write so the SDK can persist token refreshes)
      - /home/jefferyharrell/.claude/.credentials.json:/home/rosemary/.claude/.credentials.json
    restart: unless-stopped

  rosemary-summaries:
    build:
      context: ..
      dockerfile: Rosemary-App/Dockerfile
    command: ["python", "-m", "rosemary_app.summaries"]
    environment:
      - TZ=America/Los_Angeles
      - OLLAMA_URL=http://primer:8200
      - OLLAMA_MODEL=gemma3:12b-it-qat
      - ROSEMARY_CWD=/home/rosemary
      - ROSEMARY_PLUGIN_DIR=/home/rosemary/plugin
    env_file: .env
    dns:
      - 100.100.100.100
      - 1.1.1.1
    volumes:
      # Rosemary's persistent home
      - /Pondside/Workshop/Projects/Rosemary/home:/home/rosemary
      # Plugin (read-write)
      - /Pondside/Workshop/Projects/Rosemary/Rosemary-Plugin:/home/rosemary/plugin
      # Claude credentials (read-write so the SDK can persist token refreshes)
      - /home/jefferyharrell/.claude/.credentials.json:/home/rosemary/.claude/.credentials.json
    restart: unless-stopped
